#!/usr/bin/env python3
"""
Mistral API proxy â€” served at /api/chat via Apache CGI
Deploy this file as /var/www/cgi-bin/chat.py and update the API key.
"""
import sys
import os
import json
import urllib.request
import urllib.error

# Replace with your actual Mistral API key
MISTRAL_API_KEY = "YOUR_MISTRAL_API_KEY_HERE"
MISTRAL_URL = "https://api.mistral.ai/v1/chat/completions"

def respond(status, body_dict):
    body = json.dumps(body_dict, ensure_ascii=False)
    body_bytes = body.encode("utf-8")
    out = sys.stdout.buffer
    out.write(f"Status: {status}\r\n".encode())
    out.write(b"Content-Type: application/json; charset=utf-8\r\n")
    out.write(f"Content-Length: {len(body_bytes)}\r\n".encode())
    out.write(b"Access-Control-Allow-Origin: *\r\n")
    out.write(b"\r\n")
    out.write(body_bytes)
    out.flush()

def main():
    method = os.environ.get("REQUEST_METHOD", "GET")
    if method == "OPTIONS":
        sys.stdout.buffer.write(
            b"Status: 204 No Content\r\nAccess-Control-Allow-Origin: *\r\n"
            b"Access-Control-Allow-Methods: POST, OPTIONS\r\n"
            b"Access-Control-Allow-Headers: Content-Type\r\nContent-Length: 0\r\n\r\n"
        )
        sys.stdout.buffer.flush()
        return
    if method != "POST":
        respond("405 Method Not Allowed", {"error": "Only POST supported"})
        return
    try:
        raw = sys.stdin.buffer.read(int(os.environ.get("CONTENT_LENGTH", 0)))
        payload = json.loads(raw)
    except Exception as e:
        respond("400 Bad Request", {"error": str(e)})
        return
    req = urllib.request.Request(
        MISTRAL_URL, data=json.dumps(payload).encode("utf-8"),
        headers={"Content-Type": "application/json", "Authorization": f"Bearer {MISTRAL_API_KEY}"},
        method="POST",
    )
    try:
        with urllib.request.urlopen(req, timeout=30) as resp:
            respond("200 OK", json.loads(resp.read()))
    except urllib.error.HTTPError as e:
        respond(f"{e.code} {e.reason}", {"error": e.read().decode()})
    except Exception as e:
        respond("502 Bad Gateway", {"error": str(e)})

main()
